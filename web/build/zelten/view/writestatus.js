define(["backbone","zelten/model/message","zelten/view/modaldialog","autosize","select2"],function(e,t,n){var r=e.View.extend({events:{"click .message":"showActions","click .stream-message-add-cancel":"cancelPosting","click .link-add-toggle":"linkAddToggle","paste .link-add":"linkAddPaste","click .link-add-btn":"linkAddClick",submit:"writeMessage","click .close":"closePanel"},initialize:function(e){this.mentions=e.mentions||"",this.hasPermissions=this.$el.find(".complete-permissions").length>0},closePanel:function(e){var t=$(e.currentTarget);t.parents("."+t.data("dismiss")).hide(),this.linkAddReset()},linkAddPaste:function(e){setTimeout(_.bind(this.linkAddFetchDetails,this,$(e.currentTarget)),0)},linkAddClick:function(e){this.linkAddFetchDetails(this.$el.find(".link-add"))},linkAddFetchDetails:function(e){this.$el.find(".link-add-btn").attr("disabled",!0),$.ajax({url:e.data("parse-link")+"?url="+e.val(),type:"GET",dataType:"json",success:_.bind(this.linkAddShowDetails,this),error:_.bind(this.linkAddError,this)})},linkAddShowDetails:function(e){var t=this.$el.find(".link-add-form");t.hide(),t.find(".link-add-title").val(e.title),t.find(".link-add-description").val(e.description),t.find(".link-add-image").val(e.image);var n=this.$el.find(".link-add-details").show();n.find(".link-add-title").text(e.title),n.find(".link-add-description").text(e.description),n.find(".link-add-image").attr("src",e.image)},linkAddError:function(){this.$el.find(".link-add-btn").attr("disabled",!1)},linkAddToggle:function(e){return this.$el.find(".actions").is(":hidden")&&this.showActions(),this.$el.find(".link-add-form").is(":hidden")?(this.linkAddReset(),this.$el.find(".link-add-btn").attr("disabled",!1),this.$el.find(".link-add-details").hide(),this.$el.find(".link-add-form").toggle(),this.$el.find(".link-add").focus()):this.$el.find(".link-add-form").toggle(),!1},linkAddReset:function(){this.$el.find('.link-add-form input[type="hidden"]').val(""),this.$el.find(".link-add").val("")},render:function(){this.$el.find("textarea").autosize({}),this.actions=this.$el.find(".actions"),this.messageBox=this.$el.find(".message"),this.btn=this.$el.find(".stream-message-add-btn"),this.charsLeft=this.$el.find(".status-length-left"),this.hasPermissions&&this.$el.find(".complete-permissions").select2({tags:["Everybody"]})},cancelPosting:function(){var e=this.$el.find(".actions");e.slideUp()},writeMessage:function(e){var t=$(e.currentTarget),r=t.find(".message").val();if(typeof r=="undefined"||r.length==0)return t.find(".message").addClass("error"),!1;if(r.length>256){var i=new n({params:{title:"Publish this Post as Essay?",post:"The text of this status message is longer than 256 chars. Do you want to post the status as an essay instead?",label:"Yes, publish!"},success:_.bind(this.sendMessage,this,t)});return i.render(),!1}return this.sendMessage(t),!1},sendMessage:function(e){return e.find(".stream-message-add-btn").attr("disabled",!0),$.ajax({url:e.attr("action"),type:"POST",data:e.serialize(),success:_.bind(this.writeMessageSuccess,this)}),!1},writeMessageSuccess:function(e){var n=$(e),r=new t({id:n.data("message-id"),entity:n.data("entity"),published:n.data("published"),element:n});this.collection&&this.collection.add(r),this.$el.find(".stream-message-add-btn").attr("disabled",!1),this.$el.each(function(){this.reset()}),this.cancelPosting()},showActions:function(){this.actions.is(":hidden")&&(this.actions.slideDown(),this.hasPermissions&&this.$el.find(".complete-permissions").select2("data",{id:"public",text:"Everybody"}),this.mentions.length>0&&this.messageBox.val(this.mentions+" "));var e=this.messageBox.val();this.btn.attr("disabled",e.length==0),this.charsLeft.text(256-e.length)}});return r})